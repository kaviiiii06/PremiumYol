@model TrendyolClone.Models.DTOs.SiparisDetayDto
@{
    ViewData["Title"] = "İade Talebi Oluştur";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="fas fa-undo me-2"></i>İade Talebi Oluştur</h4>
                </div>
                <div class="card-body">
                    <!-- Sipariş Bilgisi -->
                    <div class="alert alert-info">
                        <strong>Sipariş No:</strong> @Model.SiparisNo<br>
                        <strong>Sipariş Tarihi:</strong> @Model.SiparisTarihi.ToString("dd MMMM yyyy")<br>
                        <strong>Toplam Tutar:</strong> @Model.ToplamTutar.ToString("C")
                    </div>

                    <form asp-action="Return" method="post" id="returnForm">
                        <input type="hidden" name="SiparisId" value="@Model.Id" />

                        <!-- İade Nedeni -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">İade Nedeni <span class="text-danger">*</span></label>
                            <select name="Neden" class="form-select" required>
                                <option value="">Seçiniz...</option>
                                <option value="1">Ürün Hatalı/Kusurlu</option>
                                <option value="2">Yanlış Ürün Gönderildi</option>
                                <option value="3">Geç Teslim Edildi</option>
                                <option value="4">Beklentimi Karşılamadı</option>
                                <option value="5">Fikrimi Değiştirdim</option>
                                <option value="6">Eksik Ürün</option>
                                <option value="7">Hasarlı Ürün</option>
                                <option value="99">Diğer</option>
                            </select>
                        </div>

                        <!-- Açıklama -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Açıklama <span class="text-danger">*</span></label>
                            <textarea name="Aciklama" class="form-control" rows="4" 
                                      placeholder="İade nedeninizi detaylı olarak açıklayın..." 
                                      required></textarea>
                            <small class="text-muted">Lütfen iade nedeninizi detaylı bir şekilde açıklayın. Bu bilgi, talebinizin daha hızlı değerlendirilmesine yardımcı olacaktır.</small>
                        </div>

                        <!-- İade Edilecek Ürünler -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">İade Edilecek Ürünler <span class="text-danger">*</span></label>
                            <div class="border rounded p-3">
                                @foreach (var urun in Model.Urunler)
                                {
                                    <div class="form-check mb-3">
                                        <input class="form-check-input return-product" 
                                               type="checkbox" 
                                               value="@urun.UrunId" 
                                               id="product_@urun.UrunId"
                                               data-max="@urun.Adet"
                                               data-price="@urun.BirimFiyat">
                                        <label class="form-check-label w-100" for="product_@urun.UrunId">
                                            <div class="d-flex align-items-center">
                                                <img src="@(string.IsNullOrEmpty(urun.ResimUrl) ? "/images/no-image.jpg" : urun.ResimUrl)" 
                                                     alt="@urun.UrunAdi" 
                                                     class="me-3" 
                                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
                                                <div class="flex-grow-1">
                                                    <strong>@urun.UrunAdi</strong><br>
                                                    <small class="text-muted">Birim Fiyat: @urun.BirimFiyat.ToString("C")</small>
                                                </div>
                                                <div class="text-end">
                                                    <div class="input-group input-group-sm" style="width: 120px;">
                                                        <span class="input-group-text">Adet:</span>
                                                        <input type="number" 
                                                               class="form-control return-quantity" 
                                                               id="quantity_@urun.UrunId"
                                                               min="1" 
                                                               max="@urun.Adet" 
                                                               value="@urun.Adet"
                                                               disabled>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                }
                            </div>
                            <small class="text-muted">İade etmek istediğiniz ürünleri seçin ve adetlerini belirtin.</small>
                        </div>

                        <!-- İade Tutarı -->
                        <div class="alert alert-success">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Tahmini İade Tutarı:</strong>
                                <h4 class="mb-0" id="returnAmount">0,00 ₺</h4>
                            </div>
                            <small class="text-muted">İade tutarı, seçtiğiniz ürünlerin toplam fiyatıdır. Kargo ücreti dahil değildir.</small>
                        </div>

                        <!-- İade Koşulları -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="acceptTerms" required>
                                <label class="form-check-label" for="acceptTerms">
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">İade koşullarını</a> okudum ve kabul ediyorum <span class="text-danger">*</span>
                                </label>
                            </div>
                        </div>

                        <!-- Butonlar -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-warning flex-grow-1" id="submitBtn">
                                <i class="fas fa-paper-plane me-2"></i>İade Talebi Oluştur
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bilgilendirme -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6><i class="fas fa-info-circle me-2 text-info"></i>İade Süreci Hakkında</h6>
                    <ul class="mb-0">
                        <li>İade talebiniz 1-2 iş günü içinde değerlendirilecektir.</li>
                        <li>Onaylanan iadeler için kargo bilgileri tarafınıza iletilecektir.</li>
                        <li>Ürünler tarafımıza ulaştıktan sonra kontrol edilecektir.</li>
                        <li>İade tutarı 3-5 iş günü içinde hesabınıza aktarılacaktır.</li>
                        <li>İade edilen ürünler orijinal ambalajında ve kullanılmamış olmalıdır.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İade Koşulları Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">İade Koşulları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>1. Genel Koşullar</h6>
                <p>Ürünler, teslim tarihinden itibaren 14 gün içinde iade edilebilir.</p>
                
                <h6>2. İade Edilebilir Ürünler</h6>
                <ul>
                    <li>Orijinal ambalajında ve etiketleri sökülmemiş ürünler</li>
                    <li>Kullanılmamış ve hasarsız ürünler</li>
                    <li>Hijyen kuralları gereği iade edilebilir ürünler</li>
                </ul>
                
                <h6>3. İade Edilemeyen Ürünler</h6>
                <ul>
                    <li>Hijyen ürünleri (açılmış ise)</li>
                    <li>Kişiye özel üretilmiş ürünler</li>
                    <li>Hızlı bozulan ürünler</li>
                </ul>
                
                <h6>4. İade Süreci</h6>
                <p>İade talebiniz onaylandıktan sonra, ürünleri kargo ile göndermeniz gerekmektedir. Kargo ücreti tarafımızca karşılanacaktır.</p>
                
                <h6>5. İade Tutarı</h6>
                <p>İade tutarı, ürün bedeli olarak hesaplanır. Kargo ücreti iade tutarına dahil değildir.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Ürün seçimi değiştiğinde
            $('.return-product').change(function() {
                const quantityInput = $('#quantity_' + $(this).val());
                quantityInput.prop('disabled', !$(this).is(':checked'));
                calculateReturnAmount();
            });

            // Adet değiştiğinde
            $('.return-quantity').change(function() {
                calculateReturnAmount();
            });

            // İade tutarını hesapla
            function calculateReturnAmount() {
                let total = 0;
                $('.return-product:checked').each(function() {
                    const productId = $(this).val();
                    const quantity = parseInt($('#quantity_' + productId).val()) || 0;
                    const price = parseFloat($(this).data('price')) || 0;
                    total += quantity * price;
                });
                $('#returnAmount').text(total.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }));
            }

            // Form submit
            $('#returnForm').submit(function(e) {
                const selectedProducts = $('.return-product:checked');
                
                if (selectedProducts.length === 0) {
                    e.preventDefault();
                    alert('Lütfen en az bir ürün seçin!');
                    return false;
                }

                // Seçili ürünleri form'a ekle
                selectedProducts.each(function() {
                    const productId = $(this).val();
                    const quantity = $('#quantity_' + productId).val();
                    
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'Urunler[' + selectedProducts.index(this) + '].UrunId',
                        value: productId
                    }).appendTo('#returnForm');
                    
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'Urunler[' + selectedProducts.index(this) + '].Adet',
                        value: quantity
                    }).appendTo('#returnForm');
                });

                $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Gönderiliyor...');
            });

            // İlk hesaplama
            calculateReturnAmount();
        });
    </script>
}
