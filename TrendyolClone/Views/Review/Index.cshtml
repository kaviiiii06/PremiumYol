@model IEnumerable<TrendyolClone.Models.DTOs.YorumListeDto>
@{
    ViewData["Title"] = "Ürün Yorumları";
    var urunId = ViewBag.UrunId;
    var siralama = ViewBag.Siralama ?? "Tarih";
    var sayfa = ViewBag.Sayfa ?? 1;
}

<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <h2>Ürün Yorumları ve Değerlendirmeleri</h2>
            
            <!-- Sıralama ve Filtreleme -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label>Sıralama:</label>
                            <select class="form-select" id="siralamaSelect" onchange="siralamaYap()">
                                <option value="Tarih" selected="@(siralama == "Tarih")">En Yeni</option>
                                <option value="Puan" selected="@(siralama == "Puan")">En Yüksek Puan</option>
                                <option value="Faydali" selected="@(siralama == "Faydali")">En Faydalı</option>
                            </select>
                        </div>
                        <div class="col-md-6 text-end">
                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                <a href="@Url.Action("Create", new { urunId = urunId })" class="btn btn-primary">
                                    <i class="bi bi-pencil"></i> Yorum Yaz
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yorumlar Listesi -->
            @if (Model != null && Model.Any())
            {
                foreach (var yorum in Model)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <strong>@yorum.KullaniciAdi</strong>
                                        <span class="ms-3 text-warning">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="bi bi-star@(i <= yorum.GenelPuan ? "-fill" : "")"></i>
                                            }
                                        </span>
                                        <small class="ms-3 text-muted">@yorum.OlusturmaTarihi.ToString("dd.MM.yyyy")</small>
                                    </div>
                                    
                                    @if (yorum.OnaylandiMi)
                                    {
                                        <span class="badge bg-success mb-2">Onaylandı</span>
                                    }
                                    
                                    <p class="mb-2">@yorum.Yorum</p>
                                    
                                    @if (yorum.Resimler != null && yorum.Resimler.Any())
                                    {
                                        <div class="mb-2">
                                            @foreach (var resim in yorum.Resimler)
                                            {
                                                <img src="@resim" alt="Yorum resmi" class="img-thumbnail me-2" style="width: 100px; height: 100px; object-fit: cover;">
                                            }
                                        </div>
                                    }
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-outline-success" onclick="faydaliIsaretle(@yorum.Id, true)">
                                            <i class="bi bi-hand-thumbs-up"></i> Faydalı (@yorum.FaydaliSayisi)
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="faydaliIsaretle(@yorum.Id, false)">
                                            <i class="bi bi-hand-thumbs-down"></i> Faydasız (@yorum.FaydasizSayisi)
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="raporEt(@yorum.Id)">
                                            <i class="bi bi-flag"></i> Rapor Et
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="border-start ps-3">
                                        <small class="text-muted d-block">Ürün Kalitesi</small>
                                        <div class="text-warning mb-2">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="bi bi-star@(i <= yorum.UrunKalitesiPuan ? "-fill" : "")"></i>
                                            }
                                        </div>
                                        
                                        <small class="text-muted d-block">Fiyat/Performans</small>
                                        <div class="text-warning mb-2">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="bi bi-star@(i <= yorum.FiyatPerformansPuan ? "-fill" : "")"></i>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(yorum.SaticiYaniti))
                            {
                                <div class="mt-3 p-3 bg-light rounded">
                                    <strong>Satıcı Yanıtı:</strong>
                                    <p class="mb-0 mt-2">@yorum.SaticiYaniti</p>
                                    <small class="text-muted">@yorum.SaticiYanitTarihi?.ToString("dd.MM.yyyy")</small>
                                </div>
                            }
                        </div>
                    </div>
                }
                
                <!-- Sayfalama -->
                <nav>
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(sayfa <= 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { urunId = urunId, siralama = siralama, sayfa = sayfa - 1 })">Önceki</a>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">@sayfa</span>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { urunId = urunId, siralama = siralama, sayfa = sayfa + 1 })">Sonraki</a>
                        </li>
                    </ul>
                </nav>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Bu ürün için henüz yorum yapılmamış.
                </div>
            }
        </div>
    </div>
</div>

<!-- Rapor Modal -->
<div class="modal fade" id="raporModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yorum Rapor Et</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="raporYorumId" />
                <div class="mb-3">
                    <label class="form-label">Rapor Sebebi</label>
                    <select class="form-select" id="raporSebep">
                        <option value="Uygunsuz">Uygunsuz İçerik</option>
                        <option value="Spam">Spam</option>
                        <option value="Yaniltici">Yanıltıcı</option>
                        <option value="Diger">Diğer</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Açıklama</label>
                    <textarea class="form-control" id="raporAciklama" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" onclick="raporGonder()">Gönder</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function siralamaYap() {
        var siralama = document.getElementById('siralamaSelect').value;
        window.location.href = '@Url.Action("Index")?urunId=@urunId&siralama=' + siralama;
    }
    
    function faydaliIsaretle(yorumId, faydali) {
        var url = faydali ? '@Url.Action("MarkHelpful")' : '@Url.Action("MarkUnhelpful")';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify({ yorumId: yorumId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Bir hata oluştu');
            }
        });
    }
    
    function raporEt(yorumId) {
        document.getElementById('raporYorumId').value = yorumId;
        new bootstrap.Modal(document.getElementById('raporModal')).show();
    }
    
    function raporGonder() {
        var yorumId = document.getElementById('raporYorumId').value;
        var sebep = document.getElementById('raporSebep').value;
        var aciklama = document.getElementById('raporAciklama').value;
        
        fetch('@Url.Action("Report")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ yorumId: yorumId, sebep: sebep, aciklama: aciklama })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('raporModal')).hide();
            }
        });
    }
</script>
}
